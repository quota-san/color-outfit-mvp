<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Color Outfit Suggest (MVP)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:16px;}
    video,canvas{width:100%; max-width:520px; border-radius:12px; background:#111;}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    .swatch{width:120px; border-radius:12px; padding:10px; border:1px solid #ddd;}
    .chip{height:48px; border-radius:10px; border:1px solid rgba(0,0,0,.08);}
    button{padding:10px 12px; border-radius:10px; border:1px solid #ccc; background:#fff;}
    .hint{color:#555; font-size:13px;}
  </style>
</head>
<body>
  <h2>撮影→中心色→配色提案（MVP）</h2>
  <p class="hint">コツ：自然光/白背景だと精度が上がります（電球色は全体が黄ばみやすい）。</p>

  <video id="v" playsinline autoplay></video>
  <div class="row">
    <button id="start">カメラ開始</button>
    <button id="snap">撮影</button>
  </div>
  <canvas id="c" width="520" height="520" style="display:none;"></canvas>

  <div id="out" class="row"></div>

<script>
const v = document.getElementById('v');
const c = document.getElementById('c');
const ctx = c.getContext('2d', { willReadFrequently: true });
const out = document.getElementById('out');

document.getElementById('start').onclick = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }, audio: false
  });
  v.srcObject = stream;
};

function clamp01(x){ return Math.max(0, Math.min(1, x)); }

// sRGB <-> HSL（簡易）
function rgbToHsl(r,g,b){
  r/=255; g/=255; b/=255;
  const max=Math.max(r,g,b), min=Math.min(r,g,b);
  let h=0, s=0, l=(max+min)/2;
  const d=max-min;
  if(d!==0){
    s = d / (1 - Math.abs(2*l - 1));
    switch(max){
      case r: h = ((g-b)/d) % 6; break;
      case g: h = (b-r)/d + 2; break;
      case b: h = (r-g)/d + 4; break;
    }
    h *= 60; if(h<0) h+=360;
  }
  return [h,s,l];
}
function hslToRgb(h,s,l){
  const C = (1 - Math.abs(2*l - 1)) * s;
  const X = C * (1 - Math.abs((h/60)%2 - 1));
  const m = l - C/2;
  let r1=0,g1=0,b1=0;
  if(0<=h && h<60){ r1=C; g1=X; }
  else if(60<=h && h<120){ r1=X; g1=C; }
  else if(120<=h && h<180){ g1=C; b1=X; }
  else if(180<=h && h<240){ g1=X; b1=C; }
  else if(240<=h && h<300){ r1=X; b1=C; }
  else { r1=C; b1=X; }
  const r=Math.round((r1+m)*255), g=Math.round((g1+m)*255), b=Math.round((b1+m)*255);
  return [r,g,b];
}
function rgbToHex(r,g,b){
  return "#" + [r,g,b].map(x=>x.toString(16).padStart(2,"0")).join("");
}

// 中心領域の平均色を取る
function sampleCenterColor(imgW, imgH){
  const size = Math.floor(Math.min(imgW, imgH) * 0.18); // 中心の18%四方
  const x = Math.floor(imgW/2 - size/2);
  const y = Math.floor(imgH/2 - size/2);
  const data = ctx.getImageData(x, y, size, size).data;

  let r=0,g=0,b=0, n=0;
  for(let i=0;i<data.length;i+=4){
    const a = data[i+3]/255;
    if(a<0.9) continue;
    r += data[i]; g += data[i+1]; b += data[i+2];
    n++;
  }
  if(n===0) return [128,128,128];
  return [Math.round(r/n), Math.round(g/n), Math.round(b/n)];
}

// 配色候補：同系色 / 差し色（補色） / 分割補色
function suggestPalette(baseRgb){
  const [h,s,l] = rgbToHsl(...baseRgb);

  const same1 = [ (h+20)%360, s, l ];
  const same2 = [ (h+340)%360, s, l ];

  const comp = [ (h+180)%360, s, l ];

  const split1 = [ (h+150)%360, s, l ];
  const split2 = [ (h+210)%360, s, l ];

  // 服向けに調整：ボトムスはやや暗め/低彩度、アクセは少し彩度上げる等（超ざっくり）
  const bottom = [ same1[0], clamp01(s*0.65), clamp01(l*0.70) ];
  const shoes  = [ same2[0], clamp01(s*0.55), clamp01(l*0.60) ];
  const accent = [ comp[0],  clamp01(Math.max(s,0.55)), clamp01(Math.min(l+0.05,0.60)) ];
  const acc2   = [ split1[0], clamp01(Math.max(s*0.9,0.45)), clamp01(Math.min(l+0.10,0.70)) ];
  const acc3   = [ split2[0], clamp01(Math.max(s*0.9,0.45)), clamp01(Math.min(l+0.10,0.70)) ];

  return [
    {label:"ベース（トップス）", hsl:[h,s,l]},
    {label:"ボトムス（同系）", hsl:bottom},
    {label:"靴（同系）", hsl:shoes},
    {label:"差し色（補色）", hsl:accent},
    {label:"アクセ候補A", hsl:acc2},
    {label:"アクセ候補B", hsl:acc3},
  ].map(x=>{
    const rgb = hslToRgb(...x.hsl);
    return {...x, rgb, hex: rgbToHex(...rgb)};
  });
}

function renderSwatches(items){
  out.innerHTML = "";
  for(const it of items){
    const div = document.createElement('div');
    div.className = "swatch";
    div.innerHTML = `
      <div class="chip" style="background:${it.hex}"></div>
      <div style="margin-top:8px;font-size:13px;">${it.label}</div>
      <div style="color:#555;font-size:12px;">${it.hex}</div>
    `;
    out.appendChild(div);
  }
}

document.getElementById('snap').onclick = () => {
  const w = 520, h = 520;
  c.width = w; c.height = h;

  // 画面の中央を正方形に切り出して描画（簡易）
  const vw = v.videoWidth, vh = v.videoHeight;
  if(!vw || !vh) return;

  const side = Math.min(vw, vh);
  const sx = Math.floor(vw/2 - side/2);
  const sy = Math.floor(vh/2 - side/2);

  ctx.drawImage(v, sx, sy, side, side, 0, 0, w, h);

  const base = sampleCenterColor(w, h);
  const palette = suggestPalette(base);
  renderSwatches(palette);
};
</script>
</body>
</html>
